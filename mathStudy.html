<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive PDF E-Book Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&family=Nanum+Myeongjo:wght@400;700&display=swap');
        
        body { font-family: 'Nanum Myeongjo', serif; }
        header, button, select, input, .ui-font { font-family: 'Nanum Gothic', sans-serif; }
        
        /* 커스텀 스크롤바 */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Iframe 로딩 애니메이션 */
        .iframe-loader {
            background: #f3f4f6 url('https://i.gifer.com/ZZ5H.gif') no-repeat center center;
            background-size: 50px;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">

    <header class="sticky top-0 z-40 bg-white shadow-md border-b border-gray-200">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center mb-3 gap-3">
                <h1 class="text-xl font-bold text-gray-800 flex items-center">
                    <i class="fab fa-google-drive mr-2 text-green-600"></i> Drive PDF E-Book
                </h1>
                
                <div class="flex gap-2">
                    <button id="authBtn" onclick="handleAuthClick()" class="hidden px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-medium transition shadow-sm">
                        <i class="fab fa-google mr-2"></i> 구글 로그인
                    </button>
                    <button id="signoutBtn" onclick="handleSignoutClick()" class="hidden px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm font-medium transition shadow-sm">
                        로그아웃
                    </button>
                    <button id="loadBtn" onclick="fetchFromDrive()" class="hidden px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-medium transition shadow-sm flex items-center">
                        <i class="fas fa-cloud-download-alt mr-2"></i> PDF 불러오기
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <select id="filterSubject" class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none"><option value="">과목 (전체)</option></select>
                <select id="filterCat1" class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none"><option value="">대단원 (전체)</option></select>
                <select id="filterCat2" class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none"><option value="">중단원 (전체)</option></select>
                <select id="filterCat3" class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none"><option value="">소단원 (전체)</option></select>
            </div>

            <div id="statusMsg" class="text-xs text-gray-500 mt-2 text-right">구글 드라이브에 로그인해주세요.</div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-6 max-w-5xl overflow-y-auto">
        <div id="contentArea" class="space-y-8">
            <div class="text-center text-gray-400 py-20">
                <i class="fas fa-file-pdf text-4xl mb-4"></i>
                <p>표시할 문서가 없습니다.<br>로그인 후 'PDF 불러오기'를 클릭하세요.</p>
            </div>
        </div>
    </main>

    <div id="solutionModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-900 bg-opacity-80 transition-opacity backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-2 text-center">
                <div class="relative transform overflow-hidden rounded-xl bg-white text-left shadow-2xl transition-all w-full max-w-5xl h-[85vh] flex flex-col">
                    
                    <div class="bg-gray-50 px-4 py-3 flex justify-between items-center border-b border-gray-200 shrink-0">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center">
                            <i class="fas fa-lightbulb mr-2 text-yellow-500"></i> 해설 보기
                        </h3>
                        <button type="button" onclick="closeModal()" class="text-gray-400 hover:text-red-500 focus:outline-none transition">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="flex-grow bg-gray-200 relative">
                        <iframe id="modalIframe" src="" class="w-full h-full border-none absolute inset-0"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // [설정] 구글 API 및 폴더 설정
        // ==========================================
        const CONFIG = {
            CLIENT_ID: '129767670296-eipi50ba5g8r1fp1rr45f6e1l4vl9bhk.apps.googleusercontent.com',       // [입력] 클라이언트 ID
            API_KEY: 'AIzaSyArljKxa14eoTIacwnDs5rtg6pfcakM2xg',           // [입력] API 키
            ROOT_FOLDER_ID: '1VZpXsfYYMOemIC8pmNv-fzcts7HWCBB2',  // [입력] 불러올 최상위 폴더 ID
            DISCOVERY_DOC: 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
            SCOPES: 'https://www.googleapis.com/auth/drive.readonly'
        };

        // --- 전역 변수 ---
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let loadedFiles = [];
        
        // 분류명 매핑 (필요에 따라 수정)
        let CATEGORY_MAP = {
            "01": "수학 I", "02": "수학 II",
            "01_01": "지수함수와 로그함수", "01_02": "삼각함수", "02_01": "함수의 극한",
            "01_01_01": "지수", "01_01_02": "로그", "01_02_01": "삼각함수의 뜻", "02_01_01": "함수의 극한값"
        };

        // ==========================================
        // 1. Google Auth & API Logic
        // ==========================================
        function gapiLoaded() { gapi.load('client', initializeGapiClient); }
        async function initializeGapiClient() {
            await gapi.client.init({ apiKey: CONFIG.API_KEY, discoveryDocs: [CONFIG.DISCOVERY_DOC] });
            gapiInited = true; maybeEnableButtons();
        }
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID, scope: CONFIG.SCOPES, callback: ''
            });
            gisInited = true; maybeEnableButtons();
        }
        function maybeEnableButtons() {
            if (gapiInited && gisInited) document.getElementById('authBtn').classList.remove('hidden');
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error) throw (resp);
                document.getElementById('authBtn').classList.add('hidden');
                document.getElementById('signoutBtn').classList.remove('hidden');
                document.getElementById('loadBtn').classList.remove('hidden');
                document.getElementById('statusMsg').innerText = "로그인 완료. 'PDF 불러오기'를 클릭하세요.";
            };
            if (gapi.client.getToken() === null) tokenClient.requestAccessToken({prompt: 'consent'});
            else tokenClient.requestAccessToken({prompt: ''});
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                document.getElementById('authBtn').classList.remove('hidden');
                document.getElementById('signoutBtn').classList.add('hidden');
                document.getElementById('loadBtn').classList.add('hidden');
                document.getElementById('contentArea').innerHTML = "";
                document.getElementById('statusMsg').innerText = "로그아웃 되었습니다.";
                loadedFiles = [];
            }
        }

        // --- Drive Fetching Logic (PDF 전용) ---
        async function fetchFromDrive() {
            const statusMsg = document.getElementById('statusMsg');
            statusMsg.textContent = "구글 드라이브 구조 분석 중...";
            loadedFiles = [];

            try {
                // 1. 루트 폴더 안의 하위 폴더들(과목) 가져오기
                const folderQuery = `'${CONFIG.ROOT_FOLDER_ID}' in parents and mimeType = 'application/vnd.google-apps.folder' and trashed = false`;
                const foldersResp = await gapi.client.drive.files.list({ q: folderQuery, fields: 'files(id, name)' });
                const subjectFolders = foldersResp.result.files;

                if (!subjectFolders || subjectFolders.length === 0) {
                    statusMsg.textContent = "지정된 폴더 안에 하위 폴더(과목)가 없습니다.";
                    return;
                }

                // 2. 각 과목 폴더 안의 PDF 파일 가져오기
                let fetchPromises = [];

                for (const folder of subjectFolders) {
                    const subjectName = folder.name;
                    // [변경] mimeType = 'application/pdf'
                    const fileQuery = `'${folder.id}' in parents and mimeType = 'application/pdf' and trashed = false`;
                    
                    fetchPromises.push(
                        gapi.client.drive.files.list({ q: fileQuery, fields: 'files(id, name)' })
                            .then(res => ({ subject: subjectName, files: res.result.files }))
                    );
                }

                statusMsg.textContent = "파일 목록 수집 중...";
                const results = await Promise.all(fetchPromises);

                // 3. 파일 목록 통합 (내용 다운로드 불필요, ID만 있으면 됨)
                let allFiles = [];
                results.forEach(group => {
                    group.files.forEach(file => {
                        allFiles.push({
                            id: file.id,
                            name: file.name,
                            subject: group.subject
                        });
                    });
                });

                if (allFiles.length === 0) {
                    statusMsg.textContent = "폴더 안에 PDF 파일이 없습니다.";
                    return;
                }

                // 4. 데이터 가공
                processDriveData(allFiles);

            } catch (err) {
                console.error(err);
                statusMsg.textContent = "오류 발생: " + err.message;
            }
        }

        // ==========================================
        // 2. Data Processing (PDF Version)
        // ==========================================
        
        function processDriveData(files) {
            loadedFiles = [];
            // [변경] 확장자가 .pdf 인지 확인하는 정규식
            const regex = /^(\d{2})_(\d{2})_(\d{2})_([^_]+)_(\d{3})(?:_(p|s))?\.pdf$/i;

            for (const file of files) {
                const match = file.name.match(regex);
                if (match) {
                    // [핵심] 구글 드라이브 미리보기 URL 생성
                    const previewUrl = `https://drive.google.com/file/d/${file.id}/preview`;

                    loadedFiles.push({
                        id: file.id,
                        fileName: file.name,
                        subject: file.subject,
                        cat1: match[1],
                        cat2: match[2],
                        cat3: match[3],
                        type: match[4],
                        serial: match[5],
                        kind: match[6] || "", // undefined면 공란(개념)
                        keyCat1: match[1],
                        keyCat2: `${match[1]}_${match[2]}`,
                        keyCat3: `${match[1]}_${match[2]}_${match[3]}`,
                        previewUrl: previewUrl // iframe src로 사용
                    });
                }
            }

            document.getElementById('statusMsg').textContent = `총 ${loadedFiles.length}개의 PDF 문서를 로드했습니다.`;
            updateFilters();
            applyFilters();
        }


        // ==========================================
        // 3. Filter & UI Logic
        // ==========================================
        const filterSubject = document.getElementById('filterSubject');
        const filterCat1 = document.getElementById('filterCat1');
        const filterCat2 = document.getElementById('filterCat2');
        const filterCat3 = document.getElementById('filterCat3');

        function populateSelect(selectEl, values, mapFn, defaultText) {
            selectEl.innerHTML = `<option value="">${defaultText}</option>`;
            values.forEach(val => {
                const option = document.createElement('option');
                option.value = val;
                option.textContent = mapFn ? (mapFn(val) || val) : val;
                selectEl.appendChild(option);
            });
        }
        function getMapName(code) { return CATEGORY_MAP[code] ? `${code}. ${CATEGORY_MAP[code]}` : code; }

        function updateFilters() {
            const subjects = [...new Set(loadedFiles.map(f => f.subject))].sort();
            populateSelect(filterSubject, subjects, null, "과목 (전체)");
            const cat1s = [...new Set(loadedFiles.map(f => f.keyCat1))].sort();
            populateSelect(filterCat1, cat1s, getMapName, "대단원 (전체)");
            filterCat2.innerHTML = '<option value="">중단원 (전체)</option>';
            filterCat3.innerHTML = '<option value="">소단원 (전체)</option>';
        }

        filterSubject.addEventListener('change', () => applyFilters());
        filterCat1.addEventListener('change', () => {
            const selectedVal = filterCat1.value;
            const relevantFiles = loadedFiles.filter(f => !selectedVal || f.keyCat1 === selectedVal);
            const cat2s = [...new Set(relevantFiles.map(f => f.keyCat2))].sort();
            populateSelect(filterCat2, cat2s, getMapName, "중단원 (전체)");
            filterCat3.innerHTML = '<option value="">소단원 (전체)</option>';
            applyFilters();
        });
        filterCat2.addEventListener('change', () => {
            const selectedVal = filterCat2.value;
            const relevantFiles = loadedFiles.filter(f => !selectedVal || f.keyCat2 === selectedVal);
            const cat3s = [...new Set(relevantFiles.map(f => f.keyCat3))].sort();
            populateSelect(filterCat3, cat3s, getMapName, "소단원 (전체)");
            applyFilters();
        });
        filterCat3.addEventListener('change', applyFilters);


        // --- 4. Rendering Logic (PDF Iframe) ---

        function applyFilters() {
            const sSubject = filterSubject.value;
            const sCat1 = filterCat1.value;
            const sCat2 = filterCat2.value;
            const sCat3 = filterCat3.value;
            
            let targetFiles = loadedFiles.filter(f => {
                if (sSubject && f.subject !== sSubject) return false;
                if (sCat1 && f.keyCat1 !== sCat1) return false;
                if (sCat2 && f.keyCat2 !== sCat2) return false;
                if (sCat3 && f.keyCat3 !== sCat3) return false;
                return true;
            });

            targetFiles.sort((a, b) => {
                if (a.serial !== b.serial) return a.serial.localeCompare(b.serial);
                const kindOrder = { "": 0, "p": 1, "s": 2 };
                return kindOrder[a.kind] - kindOrder[b.kind];
            });

            renderContent(targetFiles);
        }

        function renderContent(files) {
            const container = document.getElementById('contentArea');
            container.innerHTML = "";
            
            if (files.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 py-10">조건에 맞는 문서가 없습니다.</div>`;
                return;
            }

            // 해설 맵 생성
            const solutionMap = {};
            files.filter(f => f.kind === 's').forEach(f => {
                const key = `${f.keyCat3}_${f.type}_${f.serial}`;
                solutionMap[key] = f;
            });

            // 문제(p)와 개념("")만 렌더링
            files.filter(f => f.kind !== 's').forEach(file => {
                const isProblem = file.kind === 'p';
                
                const wrapper = document.createElement('div');
                wrapper.className = "bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden mb-6 relative hover:shadow-lg transition";

                // 메타 정보
                const header = `<div class="bg-gray-50 px-4 py-2 border-b border-gray-100 flex justify-between items-center">
                    <span class="text-xs font-bold text-gray-500">${getMapName(file.keyCat3)}</span>
                    <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-bold">No.${file.serial} ${isProblem ? '문제' : '개념'}</span>
                </div>`;

                // [변경] PDF Iframe 뷰어
                // iframe-loader 클래스로 로딩 인디케이터 표시
                const viewer = `<div class="w-full h-[600px] bg-gray-100 iframe-loader relative">
                    <iframe src="${file.previewUrl}" class="w-full h-full border-none" allow="autoplay"></iframe>
                </div>`;

                let btnHtml = "";
                if (isProblem) {
                    const key = `${file.keyCat3}_${file.type}_${file.serial}`;
                    const solutionFile = solutionMap[key];
                    if (solutionFile) {
                        // 해설 버튼을 뷰어 하단에 배치
                        btnHtml = `<div class="p-3 bg-white border-t border-gray-100 flex justify-end">
                            <button onclick="openModal('${solutionFile.previewUrl}')" class="bg-indigo-600 text-white text-sm px-4 py-2 rounded hover:bg-indigo-700 transition flex items-center shadow-sm">
                                <i class="fas fa-search mr-2"></i> 해설 보기
                            </button>
                        </div>`;
                    }
                }

                wrapper.innerHTML = header + viewer + btnHtml;
                container.appendChild(wrapper);
            });
        }

        // --- 5. Modal Logic (Iframe for Solution) ---
        const modal = document.getElementById('solutionModal');
        const modalIframe = document.getElementById('modalIframe');

        function openModal(url) {
            modalIframe.src = url;
            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
            modalIframe.src = ""; // iframe 초기화 (소리/영상 멈춤 및 메모리 해제)
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === "Escape" && !modal.classList.contains('hidden')) closeModal();
        });

    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

</body>
</html>
